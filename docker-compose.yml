services:
  qdrant:
    image: qdrant/qdrant:v1.16
    container_name: letter-writer-qdrant
    restart: unless-stopped
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      # Use the existing volume from your previously initialized Qdrant container
      - letter-writer_qdrant_storage:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    # Health check removed - Qdrant container doesn't have wget/curl
    # The service will start and be ready when it's listening on port 6333
    # healthcheck:
    #   test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:6333/health"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: letter-writer-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - .:/app
      - ./letters:/app/letters
      - ./trace:/app/trace
      - ./jobs:/app/jobs
      # Mount CV directory if it's outside the project directory
      # Adjust the Windows path to match your CV location:
      - C:/Users/franc/Documents/GitHub/cv-latex:/app/cv-external
    environment:
      - DJANGO_DEBUG=true
      - DJANGO_ALLOWED_HOSTS=*
      # Connect to Qdrant service in docker-compose network
      - QDRANT_HOST=${QDRANT_HOST:-qdrant}
      - QDRANT_PORT=${QDRANT_PORT:-6333}
      # Override CV_PATH for Docker - uses path relative to /app (project root)
      # This overrides the CV_PATH from .env file, so local .env can keep Windows paths
      # The CV directory is mounted at /app/cv-external
      - CV_PATH=cv-external/Experience.md
    env_file:
      - .env
    depends_on:
      qdrant:
        condition: service_started
    command: python letter_writer_server/manage.py runserver 0.0.0.0:8000

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: letter-writer-frontend
    restart: unless-stopped
    ports:
      - "5173:5173"
    volumes:
      - ./letter_writer_web:/app
      - /app/node_modules
    environment:
      - VITE_API_URL=http://backend:8000
    depends_on:
      - backend
    command: npm run dev -- --host 0.0.0.0

volumes:
  # Use existing volume from your previously initialized Qdrant container
  letter-writer_qdrant_storage:
    external: true

