services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: letter-writer-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - .:/app
      - ./letters:/app/letters
      - ./trace:/app/trace
      - ./jobs:/app/jobs
      # Mount CV directory if it's outside the project directory
      # Adjust the path to match your CV location:
      - ${CV_LOCAL_PATH:-./cv-external}:/app/cv-external
      # Mount Google Cloud credentials file for Firestore access
      # Set GOOGLE_APPLICATION_CREDENTIALS_HOST to the host path of your service account JSON
      # If not set, defaults to ./gcloud-credentials.json in the project root
      # Note: For Podman (rootless), the file must be readable by your user (e.g., chmod 600 or 644)
      - ${GOOGLE_APPLICATION_CREDENTIALS_HOST:-./gcloud-credentials.json}:/app/gcloud-credentials.json:ro
    environment:
      # DJANGO_DEBUG should be false in production
      # DJANGO_ALLOWED_HOSTS is auto-detected (GCP) or defaults to localhost/backend (local)
      # DJANGO_SECRET_KEY must be set in .env file
      # Firestore connection (uses Application Default Credentials)
      # The credentials file is mounted at /app/gcloud-credentials.json
      - GOOGLE_CLOUD_PROJECT=${GOOGLE_CLOUD_PROJECT}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/gcloud-credentials.json
      - FIRESTORE_PROJECT_ID=${FIRESTORE_PROJECT_ID}
      - FIRESTORE_DATABASE=letter
      - FIRESTORE_COLLECTION=${FIRESTORE_COLLECTION:-documents}
      # Override CV_PATH for Docker - uses path relative to /app (project root)
      # This overrides the CV_PATH from .env file, so local .env can keep Windows paths
      # The CV directory is mounted at /app/cv-external
      - CV_PATH=cv-external/Experience.md
      # Google OAuth credentials (explicitly set to ensure they're loaded)
      - GOOGLE_OAUTH_CLIENT_ID=${GOOGLE_OAUTH_CLIENT_ID}
      - GOOGLE_OAUTH_SECRET=${GOOGLE_OAUTH_SECRET}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:5173}
      # Redis for cost tracking (optional - falls back to in-memory)
      - REDIS_URL=redis://redis:6379/0
      # BigQuery for cost analytics (uses same credentials as Firestore)
      - BIGQUERY_PROJECT=${GOOGLE_CLOUD_PROJECT}
      - BIGQUERY_DATASET=${BIGQUERY_DATASET:-letter_writer}
      - BIGQUERY_TABLE=${BIGQUERY_TABLE:-api_costs}
      # Google Translate API key (for translation costs tracking)
      - GOOGLE_TRANSLATE_API_KEY=${GOOGLE_TRANSLATE_API_KEY}
    env_file:
      - .env
    depends_on:
      - redis
    command: python letter_writer_server/manage.py runserver 0.0.0.0:8000

  redis:
    image: docker.io/redis:alpine
    container_name: letter-writer-redis
    restart: unless-stopped
    ports:
      - "6379:6379"

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: letter-writer-frontend
    restart: unless-stopped
    ports:
      - "5173:5173"
    volumes:
      - ./letter_writer_web:/app
      - /app/node_modules
    environment:
      - VITE_API_URL=http://backend:8000
    depends_on:
      - backend
    command: npm run dev -- --host 0.0.0.0

# Volumes removed - no longer using Qdrant or MongoDB
# Firestore is a managed service, no local volumes needed

